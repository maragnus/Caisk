@page "/apps/{ParentName}/{Name}"
@using Caisk.Applications
@using Caisk.GitHub
@using Caisk.Managers.Mongo
@using Caisk.SecureShells
@inherits BaseProfileEditor<Caisk.Applications.ApplicationEnvironmentProfile, Caisk.Applications.IApplicationEnvironmentStore>

@rendermode InteractiveServer

<MyMudProviders/>
<PageTitle>Application: @ParentName/@Name (Caisk)</PageTitle>
<NavigationLock OnBeforeInternalNavigation="OnBeforeInternalNavigation" ConfirmExternalNavigation="IsTouched"/>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Application Environment</MudText>
    <MudText Class="mb-8">Configure, update, deploy application environment</MudText>

    <MudPaper Class="pa-4">
        @if (IsLoading)
        {
            <MudProgressCircular Color="Color.Default" Indeterminate="true"/>
        }
        else
        {
            <MudForm Model="Profile" @bind-IsValid="IsValid" @bind-IsTouched="IsTouched">
                <MudStack Spacing="4">
                    <MudTextField Label="Name" ReadOnly Value="Profile.Name"/>
                    <MudTextField Label="Application" ReadOnly Value="Profile.ParentName"/>
                    <MudTextField Label="Entry Urls (semi-colon delimited)" Value="Profile.EntryUrl"/>
                    <MudTextField Label="Health Check Url" Value="Profile.HealthCheckUrl"/>
                    <ProfileSelector T="MongoDatabaseProfile" @bind-Value="Profile.MongoDatabaseName"/>
                    <ProfileSelector T="SecureShellProfile" @bind-Value="Profile.SecureShellName"/>
                    <MudGrid>
                        @foreach (var service in Profile.Services)
                        {
                            <MudItem sm="6" md="3">
                                <MudTextField T="string" Value="@service.Name" ReadOnly Label="Service"/>
                            </MudItem>
                            <MudItem sm="6" md="3">
                                <ProfileSelector T="GitHubRepositoryProfile" @bind-Value="@service.RepositoryName" Label="Repository"/>
                            </MudItem>
                            <MudItem sm="6" md="3">
                                <MudTextField T="string" @bind-Value="@service.ActionId" Label="Workflow ID"/>
                            </MudItem>
                            <MudItem sm="6" md="3">
                                <MudTextField T="string" Value="@service.Image.ToString()" ReadOnly Label="Image"/>
                            </MudItem>
                        }
                    </MudGrid>
                    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.FlexEnd" Spacing="4">
                        <MudButton StartIcon="@Icons.Material.Filled.Launch" OnClick="@Deploy" Color="Color.Error">Deploy</MudButton>
                        <MudButton OnClick="@EditDockerCompose" Color="Color.Info" StartIcon="@Icons.Material.Filled.Edit">Docker Compose</MudButton>
                        <MudDivider Vertical DividerType="DividerType.Middle" FlexItem/>
                        @if (!IsNew)
                        {
                            <MudButton StartIcon="@Icons.Material.Filled.Delete" OnClick="@Delete" Color="Color.Error">Delete</MudButton>
                            <MudButton StartIcon="@Icons.Material.Filled.Edit" OnClick="@Rename" Color="Color.Warning">Rename</MudButton>
                            <MudDivider Vertical DividerType="DividerType.Middle" FlexItem/>
                        }
                        <MudButton OnClick="@Cancel" Color="Color.Default">Cancel</MudButton>
                        <MudButton StartIcon="@Icons.Material.Filled.Save" OnClick="@SaveAndClose" Color="Color.Primary" Variant="Variant.Filled" Disabled="!IsValid">Store</MudButton>
                    </MudStack>
                </MudStack>
            </MudForm>
        }
    </MudPaper>
</MudContainer>

@code {

    private async Task EditDockerCompose()
    {
        await Save();
        NavigationManager.NavigateTo(Common.ProfileUrl<ApplicationEnvironmentProfile>(Profile.Name, Profile.ParentName) + "/docker-compose");
    }

    private async Task Deploy()
    {
        await Save();
        NavigationManager.NavigateTo(Common.ProfileUrl<ApplicationEnvironmentProfile>(Profile.Name, Profile.ParentName) + "/deploy");
    }

}